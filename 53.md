# Дополнительные функции mysqli.

### Получение количества записей, которые вернул запрос

В mysqli есть специальная функция, которая может сказать, какое количество строк вернул запрос SELECT.   
Традиционно употребляется в двух случаях:

а) когда это не нужно    
б) когда приводит к катастрофическим последствиям

Первый вариант - это когда мы хотим узнать, вернул ли запрос хоть какие-то данные, или нет. Но на этот случай у нас есть **сами данные**. Зачем отдельно запрашивать их количество, если мы все равно будем эти данные получать в переменную, которую потом и можно будет использовать чтобы узнать, вернул ли запрос что-нибудь или нет.

Второй вариант - если эта функция используется чтобы посчитать, сколько строк лежит в БД. В таком варианте это будет откровенное вредительство, поскольку данных может быть **очень** много, и все эти данные БД должна сначала получить у себя, а потом отправить в РНР. Заняв всю доступную память или даже вызвав фатальную ошибку нехватки памяти.  

Правильным решением этой задачи будет сделать запрос вида `SELECT COUNT(*) FROM ...`. В этом случае БД сама внутри себя посчитает количество строк (очень быстро) и вернёт только одно число, которое не занимает оперативную память вообще. 

Вот и получается, что функция `mysqli_num_rows()` является либо вредной, либо бесполезной

### Получение количества записей, которые затронул запрос на изменение данных

Для этого в mysqli есть на самом деле не одна, а **две** функции. 

В общем случае применяется функция `affected_rows()`. Но у неё есть одна особенность: для запросов UPDATE она считает только те строки, в которых что-то изменилось. Если же БД нужную строку нашла, но новые данные совпадают с теми что уже лежат в БД, то `affected_rows()` вернёт 0.

Обычно это не явдяется проблемой - нам, по сути, не интересно знать, обновились ли какие-то данные, или нет. Главное чтобы ошибки не было, а ошибки у нас проверяются совсем в другом месте. Но на случай ,если там прямо вот очень хочется узнать отдельно, сколько строк запрос нашел и сколько затронул - есть функция `mysqli_info()`. Она, правда, возвращает строку, но её совсем несложно распарсить на отдельные цифры.

### Получение автоинкрементного идентификатора только что добавленной записи

Если у теблицы есть автоинкрементный уникальный идентификатор, (поле с атрибутами PRIMATY KEY auto_increment), то после вставки новой записи можно получить значение этого поля функцией insert_id.

## Список основных функций mysqli

Поскольку функций для работы с БД довольно много, следует пройтись по самым важным из них, чтобы было общее представление о том, какие операции они могут выполнять, а так же привести типовые примеры задач, в которых они применяются. 


- **`mysqli_report()`** устанавливает режим информирования об ошибках. Пишется 1 раз перед коннектом в виде `mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);`
- **`mysqli_connect()`** устанавливает соединение с БД. должна вызываться ровно один раз за время выполнения скрипта
- **`set_charset()`**  устанавливает кодировку соединения, Пишется 1 раз после коннекта в виде `$db->set_charset("utf8mb4")`;
- **`mysqli_query()`** выполняет запрос, если в нем не содержится переменных
- **`mysqli_prepare`** - подготавливает запрос, если в нем используются переменные
- **`mysqli_stmt_bind_param`** - привязывает переменные к запросу
- **`mysqli_stmt_execute`** - выполняет подготовленный запрос
- **`mysqli_stmt_get_result`** - возвращает результат запроса SELECT выполненного через prepare/execute  для использования функциями mysqli_fetch_*
- **`insert_id`** - возвращает автоинкрементный идентификатор. В объектном варианте не метод (функция), а переменная (свойстов) - т.е. вызывается без скобок
- **`mysqli_fetch_assoc`** - основная функция получения текущей строки из результата запроса. возвращает ассоциативный массив
- **`mysqli_fetch_row`** - иногда нумерованный массив удобнее ассоциативного
- **`mysqli_fetch_object`** - для эстетов
- **`mysqli_fetch_all`** - возвращает сразу массив строк, которые вернул запрос


## Устаревшие и бесполезные функции

Веб-программирование - молодая и стремительно развивающаяся область. И РНР развивается вместе с ней. Как это всегда бывает, некоторые элементы языка и приёмы устаревают или оказываются ненужными. Ниже небольшой список таких функций, которые могут вам встретиться в существующих проектах. Их наличие с большой долей уверенности может говорить о том, что код этих проектов так же устарел

- ~~`mysqli_num_rows`~~ - бесполезная функция, практически никогда не бывает нужна. В нормальных API отсутствует.
- ~~`mysqli_select_db`~~ - устаревшая функция, БД указывается в параметрах 
- ~~`mysqli_real_escape_string`~~ - принесла неисчислимый вред в силу того, что многие поколения РНР программистов верили что эта функция предназначена для защиты от SQL инъекций. В то время как это не так, а для защиты служат подготовленные выражения.
- ~~`mysqli_connect_error`~~ - устаревшая функция, вместо неё следует использовать mysqli_report
- ~~`mysqli_error`~~ - устаревшая функция, вместо неё следует использовать mysqli_report
- `mysqli_multi_query` - выполняет несколько запросов подряд, причем в полу-асинхронном режием. очень сложная в испльзовании и небезопасная функция. Должна испльзоваться с осторожностью и никогда - для запросов, использующие переменные.

